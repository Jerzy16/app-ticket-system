<div class="fixed inset-0 bg-black/20 flex items-end justify-end z-50" (click)="onBackdropClick($event)">
  <div class="bg-white shadow-xl w-full max-w-2xl h-svh overflow-y-auto" (click)="$event.stopPropagation()">
    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between z-10">
      <div class="flex items-center gap-3 flex-1">
        <h2 class="text-xl font-semibold text-gray-800">
          {{ isEditing ? 'Editar Tarea' : 'Detalles de la Tarea' }}
        </h2>
        <span [class]="'text-xs px-3 py-1 rounded-full ' + getPriorityClass(taskForm.get('priority')?.value)">
          {{ taskForm.get('priority')?.value }}
        </span>
      </div>
      <div class="flex items-center gap-2">
        @if (!isEditing) {
          <button
            (click)="toggleEdit()"
            class="p-2 hover:bg-gray-100 rounded-lg transition-colors cursor-pointer"
            title="Editar"
            type="button"
          >
            <fa-icon [icon]="getIcon('edit')" class="text-gray-600" />
          </button>
        }
        <button
          (click)="handleCancel()"
          class="text-gray-400 hover:text-gray-600 transition-colors cursor-pointer"
          type="button"
        >
          <fa-icon [icon]="getIcon('close')" class="text-xl" />
        </button>
      </div>
    </div>
    <form [formGroup]="taskForm" (ngSubmit)="handleSave()" class="px-6 py-4 space-y-6">
      <div>
        <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
          Título de la tarea *
        </label>
        <input
          id="title"
          type="text"
          formControlName="title"
          placeholder="Título de la tarea"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
          [class.border-red-500]="isFieldInvalid('title')"
          [class.bg-gray-50]="!isEditing"
        />
        @if (isFieldInvalid('title')) {
          <p class="text-red-500 text-xs mt-1">{{ getErrorMessage('title') }}</p>
        }
      </div>
      <div>
        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
          Descripción
        </label>
        <textarea
          id="description"
          formControlName="description"
          rows="4"
          placeholder="Describe los detalles de la tarea..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none"
          [class.bg-gray-50]="!isEditing"
        ></textarea>
      </div>
      @if (isEditing) {
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Nivel de prioridad *
          </label>
          <div class="grid grid-cols-3 gap-3">
            <button
              type="button"
              (click)="setPriority('low')"
              class="px-4 py-3 rounded-lg border-2 transition-all flex items-center justify-center gap-2 cursor-pointer"
              [class.border-green-500]="taskForm.get('priority')?.value === 'low'"
              [class.bg-green-50]="taskForm.get('priority')?.value === 'low'"
              [class.border-gray-200]="taskForm.get('priority')?.value !== 'low'"
              [class.hover:border-green-300]="taskForm.get('priority')?.value !== 'low'"
            >
              <fa-icon [icon]="getIcon('arrow-down')" class="text-green-600" />
              <span class="font-medium" [class.text-green-700]="taskForm.get('priority')?.value === 'low'">
                Baja
              </span>
            </button>
            <button
              type="button"
              (click)="setPriority('medium')"
              class="px-4 py-3 rounded-lg border-2 transition-all flex items-center justify-center gap-2 cursor-pointer"
              [class.border-yellow-500]="taskForm.get('priority')?.value === 'medium'"
              [class.bg-yellow-50]="taskForm.get('priority')?.value === 'medium'"
              [class.border-gray-200]="taskForm.get('priority')?.value !== 'medium'"
              [class.hover:border-yellow-300]="taskForm.get('priority')?.value !== 'medium'"
            >
              <fa-icon [icon]="getIcon('minus')" class="text-yellow-600" />
              <span class="font-medium" [class.text-yellow-700]="taskForm.get('priority')?.value === 'medium'">
                Media
              </span>
            </button>
            <button
              type="button"
              (click)="setPriority('high')"
              class="px-4 py-3 rounded-lg border-2 transition-all flex items-center justify-center gap-2 cursor-pointer"
              [class.border-red-500]="taskForm.get('priority')?.value === 'high'"
              [class.bg-red-50]="taskForm.get('priority')?.value === 'high'"
              [class.border-gray-200]="taskForm.get('priority')?.value !== 'high'"
              [class.hover:border-red-300]="taskForm.get('priority')?.value !== 'high'"
            >
              <fa-icon [icon]="getIcon('arrow-up')" class="text-red-600" />
              <span class="font-medium" [class.text-red-700]="taskForm.get('priority')?.value === 'high'">
                Alta
              </span>
            </button>
          </div>
        </div>
      }
      <div>
        <label for="dueDate" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
          <fa-icon [icon]="getIcon('calendar')" />
          Fecha de vencimiento
        </label>
        <input
          id="dueDate"
          type="date"
          formControlName="dueDate"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
          [class.bg-gray-50]="!isEditing"
        />
      </div>
      <div>
        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
          <fa-icon [icon]="getIcon('user')" />
          Asignado a
        </label>
        @if (isEditing) {
          <div class="border border-gray-300 rounded-lg p-3 max-h-64 overflow-y-auto space-y-1">
            @for (member of allTeamMembers; track member.id) {
              <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                <input
                  type="checkbox"
                  [checked]="isAssigned(member.name)"
                  (change)="toggleAssignment(member.name)"
                  class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                />
                <img [src]="member.photo" [alt]="member.name" class="w-8 h-8 rounded-full object-cover" />
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-800">{{ member.name }}</p>
                  <p class="text-xs text-gray-500">{{ member.post }}</p>
                </div>
              </label>
            }
          </div>
        }
        @if (selectedMembers.length > 0) {
          <div class="mt-3 flex flex-wrap gap-2">
            @for (name of selectedMembers; track name) {
              <span class="inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
                {{ name }}
                @if (isEditing) {
                  <button
                    type="button"
                    (click)="toggleAssignment(name)"
                    class="hover:text-blue-900 transition-colors cursor-pointer"
                  >
                    <fa-icon [icon]="getIcon('close')" class="text-xs" />
                  </button>
                }
              </span>
            }
          </div>
        } @else {
          <p class="text-sm text-gray-500 italic">Sin asignar</p>
        }
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          <fa-icon [icon]="getIcon('location')" class="mr-1" />
          Ubicación de la tarea
        </label>
        <div class="space-y-3">
          <div id="taskDetailMap" class="w-full h-64 rounded-lg border border-gray-300 overflow-hidden"></div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="latitude" class="block text-xs font-medium text-gray-600 mb-1">
                Latitud
              </label>
              <input
                id="latitude"
                type="number"
                step="0.000001"
                formControlName="latitude"
                (ngModelChange)="onCoordinateChange()"
                placeholder="-12.0464"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                [class.bg-gray-50]="!isEditing"
              />
            </div>
            <div>
              <label for="longitude" class="block text-xs font-medium text-gray-600 mb-1">
                Longitud
              </label>
              <input
                id="longitude"
                type="number"
                step="0.000001"
                formControlName="longitude"
                (ngModelChange)="onCoordinateChange()"
                placeholder="-77.0428"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                [class.bg-gray-50]="!isEditing"
              />
            </div>
          </div>
          @if (isEditing) {
            <p class="text-xs text-gray-500">
              <fa-icon [icon]="getIcon('info')" class="mr-1" />
              Haz clic en el mapa o arrastra el marcador para cambiar la ubicación
            </p>
          }
        </div>
      </div>
    </form>
    <div class="sticky z-10000 bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4 flex items-center justify-end gap-3">
      <button
        type="button"
        (click)="handleCancel()"
        class="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors font-medium cursor-pointer"
      >
        {{ isEditing ? 'Cancelar' : 'Cerrar' }}
      </button>
      @if (isEditing) {
        <button
          type="button"
          (click)="handleSave()"
          class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium flex items-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed cursor-pointer"
          [disabled]="taskForm.invalid"
        >
          <fa-icon [icon]="getIcon('check')" />
          Guardar cambios
        </button>
      }
    </div>
  </div>
</div>
